name: Compare & Promote (CD)

on:
  repository_dispatch:
    types: [model-staged]
  workflow_dispatch: {}

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      # 1) 최신 main 체크아웃 (정확한 커밋 보장)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # 2) Python 세팅
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3) 의존성 설치 (SDK 전용)
      - name: Install Python dependencies
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install "azure-ai-ml>=1.12.0,<2.0.0" "azure-identity>=1.15.0,<2.0.0"
          pip install pandas numpy scikit-learn requests pyarrow

      # 4) Azure 로그인 (Service Principal JSON)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_INFO }}

      # 5) 기본값 설정 + 구독ID 환경변수로 노출
      - name: Set defaults & export subscription id
        shell: bash
        run: |
          set -euxo pipefail
          az configure --defaults group=1dt-final-team4 workspace=team4_ML
          echo "SUBSCRIPTION_ID=$(az account show --query id -o tsv)" >> $GITHUB_ENV
          az account show

      # 6) 최신 SDK-only 스크립트가 맞는지 확인 + 구버전(az ml data download) 차단
      - name: Assert we are running the latest SDK-only script
        shell: bash
        run: |
          set -euxo pipefail
          echo "Commit: $GITHUB_SHA"
          git log -1 --oneline
          echo "==== file path ===="
          ls -l scripts/compare_and_promote_from_data_asset.py
          echo "==== first 150 lines of script ===="
          sed -n '1,150p' scripts/compare_and_promote_from_data_asset.py
          echo "==== guard: forbid CLI data download ===="
          if grep -R -nE 'az[[:space:]]+ml[[:space:]]+data[[:space:]]+download' scripts/compare_and_promote_from_data_asset.py; then
            echo 'ERROR: Found legacy "az ml data download" in the script'; exit 1
          fi

      # 7) 비교 & 승격 실행
      - name: Compare & Promote
        env:
          AZ_RESOURCE_GROUP: "1dt-final-team4"
          AZ_ML_WORKSPACE:  "team4_ML"

          DATA_ASSET_NAME: "test_csv"
          DATA_ASSET_VERSION: "1"

          LABEL_COL: "realScore_clean"
          # FEATURE_COLS: "col1,col2,..."  # 필요 시 명시(미지정 시 label 제외 전체 사용)

          ENDPOINT_NAME: "team4-rt-ab"
          ENDPOINT_URL: "https://team4-rt-ab.eastus2.inference.ml.azure.com/score"
          API_KEY: ${{ secrets.AML_ENDPOINT_KEY }}

          DEPLOYMENT_A: "final0922-1"   # Champion
          DEPLOYMENT_B: "final0922-2"   # Challenger

          PROMOTE_RULE: "rmse<=0.98 and r2>=-0.01"
        run: |
          set -euxo pipefail
          python scripts/compare_and_promote_from_data_asset.py
